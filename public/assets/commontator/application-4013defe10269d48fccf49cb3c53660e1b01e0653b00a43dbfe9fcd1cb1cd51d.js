!function(){var e="object"==typeof self&&self.self===self&&self||"object"==typeof global&&global.global===global&&global,t=e._,n=Array.prototype,a=Object.prototype,i=n.push,o=n.slice,r=a.toString,s=a.hasOwnProperty,c=Array.isArray,l=Object.keys,d=Object.create,u=function(){},h=function(e){return e instanceof h?e:this instanceof h?void(this._wrapped=e):new h(e)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=h),exports._=h):e._=h,h.VERSION="1.8.3";var m=function(e,t,n){if(void 0===t)return e;switch(null==n?3:n){case 1:return function(n){return e.call(t,n)};case 2:return function(n,a){return e.call(t,n,a)};case 3:return function(n,a,i){return e.call(t,n,a,i)};case 4:return function(n,a,i,o){return e.call(t,n,a,i,o)}}return function(){return e.apply(t,arguments)}},p=function(e,t,n){return null==e?h.identity:h.isFunction(e)?m(e,t,n):h.isObject(e)?h.matcher(e):h.property(e)};h.iteratee=function(e,t){return p(e,t,1/0)};var f=function(e,t){return t=null==t?e.length-1:+t,function(){var n,a=Math.max(arguments.length-t,0),i=Array(a);for(n=0;a>n;n++)i[n]=arguments[n+t];switch(t){case 0:return e.call(this,i);case 1:return e.call(this,arguments[0],i);case 2:return e.call(this,arguments[0],arguments[1],i)}var o=Array(t+1);for(n=0;t>n;n++)o[n]=arguments[n];return o[t]=i,e.apply(this,o)}},g=function(e){if(!h.isObject(e))return{};if(d)return d(e);u.prototype=e;var t=new u;return u.prototype=null,t},v=function(e){return function(t){return null==t?void 0:t[e]}},y=Math.pow(2,53)-1,b=v("length"),S=function(e){var t=b(e);return"number"==typeof t&&t>=0&&y>=t};h.each=h.forEach=function(e,t,n){t=m(t,n);var a,i;if(S(e))for(a=0,i=e.length;i>a;a++)t(e[a],a,e);else{var o=h.keys(e);for(a=0,i=o.length;i>a;a++)t(e[o[a]],o[a],e)}return e},h.map=h.collect=function(e,t,n){t=p(t,n);for(var a=!S(e)&&h.keys(e),i=(a||e).length,o=Array(i),r=0;i>r;r++){var s=a?a[r]:r;o[r]=t(e[s],s,e)}return o};var A=function(e){var t=function(t,n,a,i){var o=!S(t)&&h.keys(t),r=(o||t).length,s=e>0?0:r-1;for(i||(a=t[o?o[s]:s],s+=e);s>=0&&r>s;s+=e){var c=o?o[s]:s;a=n(a,t[c],c,t)}return a};return function(e,n,a,i){var o=arguments.length>=3;return t(e,m(n,i,4),a,o)}};h.reduce=h.foldl=h.inject=A(1),h.reduceRight=h.foldr=A(-1),h.find=h.detect=function(e,t,n){var a;return a=S(e)?h.findIndex(e,t,n):h.findKey(e,t,n),void 0!==a&&-1!==a?e[a]:void 0},h.filter=h.select=function(e,t,n){var a=[];return t=p(t,n),h.each(e,function(e,n,i){t(e,n,i)&&a.push(e)}),a},h.reject=function(e,t,n){return h.filter(e,h.negate(p(t)),n)},h.every=h.all=function(e,t,n){t=p(t,n);for(var a=!S(e)&&h.keys(e),i=(a||e).length,o=0;i>o;o++){var r=a?a[o]:o;if(!t(e[r],r,e))return!1}return!0},h.some=h.any=function(e,t,n){t=p(t,n);for(var a=!S(e)&&h.keys(e),i=(a||e).length,o=0;i>o;o++){var r=a?a[o]:o;if(t(e[r],r,e))return!0}return!1},h.contains=h.includes=h.include=function(e,t,n,a){return S(e)||(e=h.values(e)),("number"!=typeof n||a)&&(n=0),h.indexOf(e,t,n)>=0},h.invoke=f(function(e,t,n){var a=h.isFunction(t);return h.map(e,function(e){var i=a?t:e[t];return null==i?i:i.apply(e,n)})}),h.pluck=function(e,t){return h.map(e,h.property(t))},h.where=function(e,t){return h.filter(e,h.matcher(t))},h.findWhere=function(e,t){return h.find(e,h.matcher(t))},h.max=function(e,t,n){var a,i,o=-1/0,r=-1/0;if(null==t&&null!=e){e=S(e)?e:h.values(e);for(var s=0,c=e.length;c>s;s++)a=e[s],a>o&&(o=a)}else t=p(t,n),h.each(e,function(e,n,a){i=t(e,n,a),(i>r||i===-1/0&&o===-1/0)&&(o=e,r=i)});return o},h.min=function(e,t,n){var a,i,o=1/0,r=1/0;if(null==t&&null!=e){e=S(e)?e:h.values(e);for(var s=0,c=e.length;c>s;s++)a=e[s],o>a&&(o=a)}else t=p(t,n),h.each(e,function(e,n,a){i=t(e,n,a),(r>i||1/0===i&&1/0===o)&&(o=e,r=i)});return o},h.shuffle=function(e){return h.sample(e,1/0)},h.sample=function(e,t,n){if(null==t||n)return S(e)||(e=h.values(e)),e[h.random(e.length-1)];var a=S(e)?h.clone(e):h.values(e),i=b(a);t=Math.max(Math.min(t,i),0);for(var o=i-1,r=0;t>r;r++){var s=h.random(r,o),c=a[r];a[r]=a[s],a[s]=c}return a.slice(0,t)},h.sortBy=function(e,t,n){return t=p(t,n),h.pluck(h.map(e,function(e,n,a){return{value:e,index:n,criteria:t(e,n,a)}}).sort(function(e,t){var n=e.criteria,a=t.criteria;if(n!==a){if(n>a||void 0===n)return 1;if(a>n||void 0===a)return-1}return e.index-t.index}),"value")};var C=function(e,t){return function(n,a,i){var o=t?[[],[]]:{};return a=p(a,i),h.each(n,function(t,i){var r=a(t,i,n);e(o,t,r)}),o}};h.groupBy=C(function(e,t,n){h.has(e,n)?e[n].push(t):e[n]=[t]}),h.indexBy=C(function(e,t,n){e[n]=t}),h.countBy=C(function(e,t,n){h.has(e,n)?e[n]++:e[n]=1}),h.toArray=function(e){return e?h.isArray(e)?o.call(e):S(e)?h.map(e,h.identity):h.values(e):[]},h.size=function(e){return null==e?0:S(e)?e.length:h.keys(e).length},h.partition=C(function(e,t,n){e[n?0:1].push(t)},!0),h.first=h.head=h.take=function(e,t,n){return null==e?void 0:null==t||n?e[0]:h.initial(e,e.length-t)},h.initial=function(e,t,n){return o.call(e,0,Math.max(0,e.length-(null==t||n?1:t)))},h.last=function(e,t,n){return null==e?void 0:null==t||n?e[e.length-1]:h.rest(e,Math.max(0,e.length-t))},h.rest=h.tail=h.drop=function(e,t,n){return o.call(e,null==t||n?1:t)},h.compact=function(e){return h.filter(e,h.identity)};var _=function(e,t,n,a){a=a||[];for(var i=a.length,o=0,r=b(e);r>o;o++){var s=e[o];if(S(s)&&(h.isArray(s)||h.isArguments(s)))if(t)for(var c=0,l=s.length;l>c;)a[i++]=s[c++];else _(s,t,n,a),i=a.length;else n||(a[i++]=s)}return a};h.flatten=function(e,t){return _(e,t,!1)},h.without=f(function(e,t){return h.difference(e,t)}),h.uniq=h.unique=function(e,t,n,a){h.isBoolean(t)||(a=n,n=t,t=!1),null!=n&&(n=p(n,a));for(var i=[],o=[],r=0,s=b(e);s>r;r++){var c=e[r],l=n?n(c,r,e):c;t?(r&&o===l||i.push(c),o=l):n?h.contains(o,l)||(o.push(l),i.push(c)):h.contains(i,c)||i.push(c)}return i},h.union=f(function(e){return h.uniq(_(e,!0,!0))}),h.intersection=function(e){for(var t=[],n=arguments.length,a=0,i=b(e);i>a;a++){var o=e[a];if(!h.contains(t,o)){var r;for(r=1;n>r&&h.contains(arguments[r],o);r++);r===n&&t.push(o)}}return t},h.difference=f(function(e,t){return t=_(t,!0,!0),h.filter(e,function(e){return!h.contains(t,e)})}),h.unzip=function(e){for(var t=e&&h.max(e,b).length||0,n=Array(t),a=0;t>a;a++)n[a]=h.pluck(e,a);return n},h.zip=f(h.unzip),h.object=function(e,t){for(var n={},a=0,i=b(e);i>a;a++)t?n[e[a]]=t[a]:n[e[a][0]]=e[a][1];return n};var w=function(e){return function(t,n,a){n=p(n,a);for(var i=b(t),o=e>0?0:i-1;o>=0&&i>o;o+=e)if(n(t[o],o,t))return o;return-1}};h.findIndex=w(1),h.findLastIndex=w(-1),h.sortedIndex=function(e,t,n,a){n=p(n,a,1);for(var i=n(t),o=0,r=b(e);r>o;){var s=Math.floor((o+r)/2);n(e[s])<i?o=s+1:r=s}return o};var T=function(e,t,n){return function(a,i,r){var s=0,c=b(a);if("number"==typeof r)e>0?s=r>=0?r:Math.max(r+c,s):c=r>=0?Math.min(r+1,c):r+c+1;else if(n&&r&&c)return r=n(a,i),a[r]===i?r:-1;if(i!==i)return r=t(o.call(a,s,c),h.isNaN),r>=0?r+s:-1;for(r=e>0?s:c-1;r>=0&&c>r;r+=e)if(a[r]===i)return r;return-1}};h.indexOf=T(1,h.findIndex,h.sortedIndex),h.lastIndexOf=T(-1,h.findLastIndex),h.range=function(e,t,n){null==t&&(t=e||0,e=0),n=n||1;for(var a=Math.max(Math.ceil((t-e)/n),0),i=Array(a),o=0;a>o;o++,e+=n)i[o]=e;return i};var x=function(e,t,n,a,i){if(!(a instanceof t))return e.apply(n,i);var o=g(e.prototype),r=e.apply(o,i);return h.isObject(r)?r:o};h.bind=f(function(e,t,n){if(!h.isFunction(e))throw new TypeError("Bind must be called on a function");var a=f(function(i){return x(e,a,t,this,n.concat(i))});return a}),h.partial=f(function(e,t){var n=h.partial.placeholder,a=function(){for(var i=0,o=t.length,r=Array(o),s=0;o>s;s++)r[s]=t[s]===n?arguments[i++]:t[s];for(;i<arguments.length;)r.push(arguments[i++]);return x(e,a,this,this,r)};return a}),h.partial.placeholder=h,h.bindAll=f(function(e,t){t=_(t,!1,!1);var n=t.length;if(1>n)throw new Error("bindAll must be passed function names");for(;n--;){var a=t[n];e[a]=h.bind(e[a],e)}}),h.memoize=function(e,t){var n=function(a){var i=n.cache,o=""+(t?t.apply(this,arguments):a);return h.has(i,o)||(i[o]=e.apply(this,arguments)),i[o]};return n.cache={},n},h.delay=f(function(e,t,n){return setTimeout(function(){return e.apply(null,n)},t)}),h.defer=h.partial(h.delay,h,1),h.throttle=function(e,t,n){var a,i,o,r=null,s=0;n||(n={});var c=function(){s=n.leading===!1?0:h.now(),r=null,o=e.apply(a,i),r||(a=i=null)};return function(){var l=h.now();s||n.leading!==!1||(s=l);var d=t-(l-s);return a=this,i=arguments,0>=d||d>t?(r&&(clearTimeout(r),r=null),s=l,o=e.apply(a,i),r||(a=i=null)):r||n.trailing===!1||(r=setTimeout(c,d)),o}},h.debounce=function(e,t,n){var a,i,o,r,s,c=function(){var l=h.now()-r;t>l&&l>=0?a=setTimeout(c,t-l):(a=null,n||(s=e.apply(o,i),a||(o=i=null)))};return function(){o=this,i=arguments,r=h.now();var l=n&&!a;return a||(a=setTimeout(c,t)),l&&(s=e.apply(o,i),o=i=null),s}},h.wrap=function(e,t){return h.partial(t,e)},h.negate=function(e){return function(){return!e.apply(this,arguments)}},h.compose=function(){var e=arguments,t=e.length-1;return function(){for(var n=t,a=e[t].apply(this,arguments);n--;)a=e[n].call(this,a);return a}},h.after=function(e,t){return function(){return--e<1?t.apply(this,arguments):void 0}},h.before=function(e,t){var n;return function(){return--e>0&&(n=t.apply(this,arguments)),1>=e&&(t=null),n}},h.once=h.partial(h.before,2),h.restArgs=f;var k=!{toString:null}.propertyIsEnumerable("toString"),M=["valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"],E=function(e,t){var n=M.length,i=e.constructor,o=h.isFunction(i)&&i.prototype||a,r="constructor";for(h.has(e,r)&&!h.contains(t,r)&&t.push(r);n--;)r=M[n],r in e&&e[r]!==o[r]&&!h.contains(t,r)&&t.push(r)};h.keys=function(e){if(!h.isObject(e))return[];if(l)return l(e);var t=[];for(var n in e)h.has(e,n)&&t.push(n);return k&&E(e,t),t},h.allKeys=function(e){if(!h.isObject(e))return[];var t=[];for(var n in e)t.push(n);return k&&E(e,t),t},h.values=function(e){for(var t=h.keys(e),n=t.length,a=Array(n),i=0;n>i;i++)a[i]=e[t[i]];return a},h.mapObject=function(e,t,n){t=p(t,n);for(var a=h.keys(e),i=a.length,o={},r=0;i>r;r++){var s=a[r];o[s]=t(e[s],s,e)}return o},h.pairs=function(e){for(var t=h.keys(e),n=t.length,a=Array(n),i=0;n>i;i++)a[i]=[t[i],e[t[i]]];return a},h.invert=function(e){for(var t={},n=h.keys(e),a=0,i=n.length;i>a;a++)t[e[n[a]]]=n[a];return t},h.functions=h.methods=function(e){var t=[];for(var n in e)h.isFunction(e[n])&&t.push(n);return t.sort()};var D=function(e,t){return function(n){var a=arguments.length;if(2>a||null==n)return n;for(var i=1;a>i;i++)for(var o=arguments[i],r=e(o),s=r.length,c=0;s>c;c++){var l=r[c];t&&void 0!==n[l]||(n[l]=o[l])}return n}};h.extend=D(h.allKeys),h.extendOwn=h.assign=D(h.keys),h.findKey=function(e,t,n){t=p(t,n);for(var a,i=h.keys(e),o=0,r=i.length;r>o;o++)if(a=i[o],t(e[a],a,e))return a};var N=function(e,t,n){return t in n};h.pick=f(function(e,t){var n={},a=t[0];if(null==e)return n;h.isFunction(a)?(t.length>1&&(a=m(a,t[1])),t=h.allKeys(e)):(a=N,t=_(t,!1,!1),e=Object(e));for(var i=0,o=t.length;o>i;i++){var r=t[i],s=e[r];a(s,r,e)&&(n[r]=s)}return n}),h.omit=f(function(e,t){var n,a=t[0];return h.isFunction(a)?(a=h.negate(a),t.length>1&&(n=t[1])):(t=h.map(_(t,!1,!1),String),a=function(e,n){return!h.contains(t,n)}),h.pick(e,a,n)}),h.defaults=D(h.allKeys,!0),h.create=function(e,t){var n=g(e);return t&&h.extendOwn(n,t),n},h.clone=function(e){return h.isObject(e)?h.isArray(e)?e.slice():h.extend({},e):e},h.tap=function(e,t){return t(e),e},h.isMatch=function(e,t){var n=h.keys(t),a=n.length;if(null==e)return!a;for(var i=Object(e),o=0;a>o;o++){var r=n[o];if(t[r]!==i[r]||!(r in i))return!1}return!0};var R,P;R=function(e,t,n,a){if(e===t)return 0!==e||1/e===1/t;if(null==e||null==t)return e===t;if(e!==e)return t!==t;var i=typeof e;return"function"!==i&&"object"!==i&&"object"!=typeof t?!1:P(e,t,n,a)},P=function(e,t,n,a){e instanceof h&&(e=e._wrapped),t instanceof h&&(t=t._wrapped);var i=r.call(e);if(i!==r.call(t))return!1;switch(i){case"[object RegExp]":case"[object String]":return""+e==""+t;case"[object Number]":return+e!==+e?+t!==+t:0===+e?1/+e===1/t:+e===+t;case"[object Date]":case"[object Boolean]":return+e===+t}var o="[object Array]"===i;if(!o){if("object"!=typeof e||"object"!=typeof t)return!1;var s=e.constructor,c=t.constructor;if(s!==c&&!(h.isFunction(s)&&s instanceof s&&h.isFunction(c)&&c instanceof c)&&"constructor"in e&&"constructor"in t)return!1}n=n||[],a=a||[];for(var l=n.length;l--;)if(n[l]===e)return a[l]===t;if(n.push(e),a.push(t),o){if(l=e.length,l!==t.length)return!1;for(;l--;)if(!R(e[l],t[l],n,a))return!1}else{var d,u=h.keys(e);if(l=u.length,h.keys(t).length!==l)return!1;for(;l--;)if(d=u[l],!h.has(t,d)||!R(e[d],t[d],n,a))return!1}return n.pop(),a.pop(),!0},h.isEqual=function(e,t){return R(e,t)},h.isEmpty=function(e){return null==e?!0:S(e)&&(h.isArray(e)||h.isString(e)||h.isArguments(e))?0===e.length:0===h.keys(e).length},h.isElement=function(e){return!(!e||1!==e.nodeType)},h.isArray=c||function(e){return"[object Array]"===r.call(e)},h.isObject=function(e){var t=typeof e;return"function"===t||"object"===t&&!!e},h.each(["Arguments","Function","String","Number","Date","RegExp","Error"],function(e){h["is"+e]=function(t){return r.call(t)==="[object "+e+"]"}}),h.isArguments(arguments)||(h.isArguments=function(e){return h.has(e,"callee")}),"function"!=typeof/./&&"object"!=typeof Int8Array&&(h.isFunction=function(e){return"function"==typeof e||!1}),h.isFinite=function(e){return isFinite(e)&&!isNaN(parseFloat(e))},h.isNaN=function(e){return h.isNumber(e)&&e!==+e},h.isBoolean=function(e){return e===!0||e===!1||"[object Boolean]"===r.call(e)},h.isNull=function(e){return null===e},h.isUndefined=function(e){return void 0===e},h.has=function(e,t){return null!=e&&s.call(e,t)},h.noConflict=function(){return e._=t,this},h.identity=function(e){return e},h.constant=function(e){return function(){return e}},h.noop=function(){},h.property=v,h.propertyOf=function(e){return null==e?function(){}:function(t){return e[t]}},h.matcher=h.matches=function(e){return e=h.extendOwn({},e),function(t){return h.isMatch(t,e)}},h.times=function(e,t,n){var a=Array(Math.max(0,e));t=m(t,n,1);for(var i=0;e>i;i++)a[i]=t(i);return a},h.random=function(e,t){return null==t&&(t=e,e=0),e+Math.floor(Math.random()*(t-e+1))},h.now=Date.now||function(){return(new Date).getTime()};var I={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},O=h.invert(I),L=function(e){var t=function(t){return e[t]},n="(?:"+h.keys(e).join("|")+")",a=RegExp(n),i=RegExp(n,"g");return function(e){return e=null==e?"":""+e,a.test(e)?e.replace(i,t):e}};h.escape=L(I),h.unescape=L(O),h.result=function(e,t,n){var a=null==e?void 0:e[t];return void 0===a&&(a=n),h.isFunction(a)?a.call(e):a};var B=0;h.uniqueId=function(e){var t=++B+"";return e?e+t:t},h.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var H=/(.)^/,K={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},F=/\\|'|\r|\n|\u2028|\u2029/g,j=function(e){return"\\"+K[e]};h.template=function(e,t,n){!t&&n&&(t=n),t=h.defaults({},t,h.templateSettings);var a=RegExp([(t.escape||H).source,(t.interpolate||H).source,(t.evaluate||H).source].join("|")+"|$","g"),i=0,o="__p+='";e.replace(a,function(t,n,a,r,s){return o+=e.slice(i,s).replace(F,j),i=s+t.length,n?o+="'+\n((__t=("+n+"))==null?'':_.escape(__t))+\n'":a?o+="'+\n((__t=("+a+"))==null?'':__t)+\n'":r&&(o+="';\n"+r+"\n__p+='"),t}),o+="';\n",t.variable||(o="with(obj||{}){\n"+o+"}\n"),o="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+o+"return __p;\n";var r;try{r=new Function(t.variable||"obj","_",o)}catch(s){throw s.source=o,s}var c=function(e){return r.call(this,e,h)},l=t.variable||"obj";return c.source="function("+l+"){\n"+o+"}",c},h.chain=function(e){var t=h(e);return t._chain=!0,t};var W=function(e,t){return e._chain?h(t).chain():t};h.mixin=function(e){h.each(h.functions(e),function(t){var n=h[t]=e[t];h.prototype[t]=function(){var e=[this._wrapped];return i.apply(e,arguments),W(this,n.apply(h,e))}})},h.mixin(h),h.each(["pop","push","reverse","shift","sort","splice","unshift"],function(e){var t=n[e];h.prototype[e]=function(){var n=this._wrapped;return t.apply(n,arguments),"shift"!==e&&"splice"!==e||0!==n.length||delete n[0],W(this,n)}}),h.each(["concat","join","slice"],function(e){var t=n[e];h.prototype[e]=function(){return W(this,t.apply(this._wrapped,arguments))}}),h.prototype.value=function(){return this._wrapped},h.prototype.valueOf=h.prototype.toJSON=h.prototype.value,h.prototype.toString=function(){return""+this._wrapped},"function"==typeof define&&define.amd&&define("underscore",[],function(){return h})}(),function(e,t){var n={BACKSPACE:8,TAB:9,RETURN:13,ESC:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,COMMA:188,SPACE:32,HOME:36,END:35},a={triggerChar:"@",onDataRequest:e.noop,minChars:2,allowRepeat:!1,showAvatars:!0,elastic:!0,defaultValue:"",onCaret:!1,classes:{autoCompleteItemActive:"active"},templates:{wrapper:t.template('<div class="mentions-input-box"></div>'),autocompleteList:t.template('<div class="mentions-autocomplete-list"></div>'),autocompleteListItem:t.template('<li data-ref-id="<%= id %>" data-ref-type="<%= type %>" data-display="<%= display %>"><%= content %></li>'),autocompleteListItemAvatar:t.template('<img src="<%= avatar %>" />'),autocompleteListItemIcon:t.template('<div class="icon <%= icon %>"></div>'),mentionsOverlay:t.template('<div class="mentions"><div></div></div>'),mentionItemSyntax:t.template("@[<%= value %>](<%= type %>:<%= id %>)"),mentionItemHighlight:t.template("<strong><span><%= value %></span></strong>")}},i={htmlEncode:function(e){return t.escape(e)},regexpEncode:function(e){return e.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")},highlightTerm:function(e,t){return t||t.length?e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>"):e},setCaratPosition:function(e,t){if(e.createTextRange){var n=e.createTextRange();n.move("character",t),n.select()}else e.selectionStart?(e.focus(),e.setSelectionRange(t,t)):e.focus()},rtrim:function(e){return e.replace(/\s+$/,"")}},o=function(o){function r(){E=e(M),"true"!==E.attr("data-mentions-input")&&(D=E.parent(),R=e(o.templates.wrapper()),E.wrapAll(R),R=D.find("> div.mentions-input-box"),E.attr("data-mentions-input","true"),E.bind("keydown",A),E.bind("keypress",S),E.bind("click",v),E.bind("blur",y),navigator.userAgent.indexOf("MSIE 8")>-1?E.bind("propertychange",b):E.bind("input",b),o.elastic&&E.elastic())}function s(){N=e(o.templates.autocompleteList()),N.appendTo(R),N.delegate("li","mousedown",g)}function c(){P=e(o.templates.mentionsOverlay()),P.prependTo(R)}function l(){var e=m();t.each(O,function(t){var n=o.templates.mentionItemSyntax(t);e=e.replace(new RegExp(i.regexpEncode(t.value),"g"),n)});var n=i.htmlEncode(e);t.each(O,function(e){var a=t.extend({},e,{value:i.htmlEncode(e.value)}),r=o.templates.mentionItemSyntax(a),s=o.templates.mentionItemHighlight(a);n=n.replace(new RegExp(i.regexpEncode(r),"g"),s)}),n=n.replace(/\n/g,"<br />"),n=n.replace(/ {2}/g,"&nbsp; "),E.data("messageText",e),E.trigger("updated"),P.find("div").html(n)}function d(){B=[]}function u(){var e=m();O=t.reject(O,function(t){return!t.value||-1==e.indexOf(t.value)}),O=t.compact(O)}function h(e){var n=m(),a=new RegExp("\\"+o.triggerChar+H,"gi");a.exec(n);var r=a.lastIndex-H.length-1,s=a.lastIndex,c=n.substr(0,r),u=n.substr(s,n.length),h=(c+e.value).length+1;t.find(O,function(t){return t.id==e.id})||O.push(e),d(),H="",C();var p=c+e.value+" "+u;E.val(p),E.trigger("mention"),l(),E.focus(),i.setCaratPosition(E[0],h)}function m(){return e.trim(E.val())}function p(t){var n,a,i,o,r,s,c,l,d,u,h;if((d=t[0])&&e(d).is("textarea")&&null!=d.selectionEnd){for(c={position:"absolute",overflow:"auto",whiteSpace:"pre-wrap",wordWrap:"break-word",boxSizing:"content-box",top:0,left:-9999},l=["boxSizing","fontFamily","fontSize","fontStyle","fontVariant","fontWeight","height","letterSpacing","lineHeight","paddingBottom","paddingLeft","paddingRight","paddingTop","textDecoration","textIndent","textTransform","width","word-spacing"],u=0,h=l.length;h>u;u++)r=l[u],c[r]=e(d).css(r);return i=document.createElement("div"),e(i).css(c),e(d).after(i),a=document.createTextNode(d.value.substring(0,d.selectionEnd)),n=document.createTextNode(d.value.substring(d.selectionEnd)),o=document.createElement("span"),o.innerHTML="&nbsp;",i.appendChild(a),i.appendChild(o),i.appendChild(n),i.scrollTop=d.scrollTop,s=e(o).position(),e(i).remove(),s}}function f(){var t=e(E).offset().top,n=e("body").offset().top,a=e(window).scrollTop();a>t&&e(window).scrollTop(t-n)}function g(){var t=e(this),n=L[t.attr("data-uid")];return h(n),f(),!1}function v(){d()}function y(){C()}function b(){l(),u();var e=t.lastIndexOf(B,o.triggerChar);e>-1&&(H=B.slice(e+1).join(""),H=i.rtrim(H),t.defer(t.bind(T,this,H)))}function S(e){if(e.keyCode!==n.BACKSPACE){var t=String.fromCharCode(e.which||e.keyCode);B.push(t)}}function A(a){if(a.keyCode===n.LEFT||a.keyCode===n.RIGHT||a.keyCode===n.HOME||a.keyCode===n.END)return t.defer(d),void(navigator.userAgent.indexOf("MSIE 9")>-1&&t.defer(l));if(a.keyCode===n.BACKSPACE)return void(B=B.slice(0,-1+B.length));if(!N.is(":visible"))return!0;switch(a.keyCode){case n.UP:case n.DOWN:var i=null;return i=a.keyCode===n.DOWN?I&&I.length?I.next():N.find("li").first():e(I).prev(),i.length&&_(i),!1;case n.RETURN:case n.TAB:if(I&&I.length)return I.trigger("mousedown"),!1}return!0}function C(){I=null,N.empty().hide()}function _(e){e.addClass(o.classes.autoCompleteItemActive),e.siblings().removeClass(o.classes.autoCompleteItemActive),I=e}function w(n,a){if(N.show(),!o.allowRepeat){var r=t.pluck(O,"value");a=t.reject(a,function(e){return t.include(r,e.name)})}if(!a.length)return void C();N.empty();var s=e("<ul>").appendTo(N).hide();t.each(a,function(a,r){var c=t.uniqueId("mention_");L[c]=t.extend({},a,{value:a.name});var l=e(o.templates.autocompleteListItem({id:i.htmlEncode(a.id),display:i.htmlEncode(a.name),type:i.htmlEncode(a.type),content:i.highlightTerm(i.htmlEncode(a.display?a.display:a.name),n)})).attr("data-uid",c);if(0===r&&_(l),o.showAvatars){var d;d=e(a.avatar?o.templates.autocompleteListItemAvatar({avatar:a.avatar}):o.templates.autocompleteListItemIcon({icon:a.icon})),d.prependTo(l)}l=l.appendTo(s)}),N.show(),o.onCaret&&x(N,E),s.show()}function T(e){e&&e.length&&e.length>=o.minChars?o.onDataRequest.call(this,"search",e,function(t){w(e,t)}):C()}function x(e,t){var n=p(t),a=parseInt(t.css("line-height"),10)||18;e.css("width","15em"),e.css("left",n.left),e.css("top",a+n.top);var i=t.offset().left+t.width(),o=e.offset().left+e.width();o>=i&&e.css("left",Math.abs(e.position().left-(o-i)))}function k(e){O=[];for(var t,n=i.htmlEncode(e),a=new RegExp("("+o.triggerChar+")\\[(.*?)\\]\\((.*?):(.*?)\\)","gi"),r=n;null!=(t=a.exec(n));)r=r.replace(t[0],t[1]+t[2]),O.push({id:t[4],type:t[3],value:t[2],trigger:t[1]});E.val(r),l()}var M,E,D,N,R,P,I,O=[],L={},B=[],H="";return o=e.extend(!0,{},a,o),{init:function(e){M=e,r(),s(),c(),k(o.defaultValue),o.prefillMention&&h(o.prefillMention)},val:function(e){t.isFunction(e)&&e.call(this,O.length?E.data("messageText"):m())},reset:function(){k()},getMentions:function(e){t.isFunction(e)&&e.call(this,O)}}};e.fn.mentionsInput=function(n,a){var i=arguments;return"object"!=typeof n&&n||(a=n),this.each(function(){var r=e.data(this,"mentionsInput")||e.data(this,"mentionsInput",new o(a));return t.isFunction(r[n])?r[n].apply(this,Array.prototype.slice.call(i,1)):"object"!=typeof n&&n?void e.error("Method "+n+" does not exist"):r.init.call(this,this)})}}(jQuery,_),window.Commontator={},Commontator._=window._.noConflict(),Commontator.initMentions=function(){$(".comment_form_field textarea:not(.mentions-added)").each(function(e,t){$textarea=$(t),$form=$textarea.parents("form"),threadId=$textarea.parents(".thread").attr("id").match(/[\d]+/)[0],$textarea.addClass("mentions-added"),currentValue=$textarea.val(),$textarea.mentionsInput({elastic:!1,showAvatars:!1,allowRepeat:!0,minChars:3,onDataRequest:function(e,t,n){$.getJSON("/commontator/threads/"+threadId+"/mentions.json",{q:t},function(e){n.call(this,e.mentions)})}}),$textarea.val(currentValue),$textarea.on("focusout",function(){$textarea.mentionsInput("getMentions",function(e){$form.find('input[name="mentioned_ids[]"]').remove(),$(e).each(function(e,t){$input=$("<input>",{type:"hidden",name:"mentioned_ids[]",value:t.id}),$form.append($input)})})})})};